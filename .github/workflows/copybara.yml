name: Copybara

on:
  push:
  pull_request_target:
    branches:
      - "main"
    types:
      - reopened
      - opened
      - synchronize
      - edited

jobs:
  copybara_migration:
    runs-on: ubuntu-latest
    name: "Push to Public repositories"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR number
        run: echo "PR number is ${PR_NUMBER}"
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Reopen referenced PRs
        if: github.event.action == 'reopened'
        run: |
          CONTENT="$(gh pr view "$PR_NUMBER" --json "body,comments" -q '.body, .comments[].body' | tac)"

          while read -r line; do
            if [[ $line =~ (Closes|Internal\ PR)\ ([^/]+)/([^/]+)#([0-9]+) ]]; then
              OWNER="${BASH_REMATCH[2]}"
              REPO="${BASH_REMATCH[3]}"
              OTHER_PR="${BASH_REMATCH[4]}"
              echo "Reopening PR: $OWNER/$REPO/$OTHER_PR"
              gh pr reopen --repo "$OWNER/$REPO" \
               --comment "This pull request has been reopened because of reopening of https://github.com/${{ github.repository }}/pull/${PR_NUMBER}" \
              $OTHER_PR
            fi
          done <<< "$CONTENT"
        env:
          GH_TOKEN: ${{ secrets.GH_BOT_GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIV_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          echo "https://x-access-token:${GH_TOKEN}@api.github.com" > ~/.git-credentials
        env:
          SSH_PRIV_KEY: ${{ secrets.GH_BOT_SSH_PRIV_KEY }}
          GH_TOKEN: ${{ secrets.GH_BOT_GITHUB_TOKEN }}

      - name: Read some stuff
        run: |
          ls -alh ~/.ssh

      - name: Set up Git config
        run: |
          git config --global user.name "Quantum AI Lab @ X - Automation Bot"
          git config --global user.email "quantumailabx@gmail.com"

      - uses: hazelcast/copybara-action@main
        name: "Copybara PR #${{ github.event.pull_request.number }} -> ${{ env.branch_to_sync }}"
        with:
          ssh_key: ${{ secrets.GH_BOT_SSH_PRIV_KEY }}
          access_token: ${{ secrets.GH_BOT_GITHUB_TOKEN }}
          sot_repo: NeuralQXLab/netket_pro
          sot_branch: main
          destination_repo: NeuralQXLab/nqxpack
          copybara_options: "--nogit-destination-rebase"
          custom_config: .copybara/copy.bara.sky
